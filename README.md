# stripe-grpc-http-starter
Starter template for a Go backend with gRPC, grpc-gateway HTTP, Protobuf (buf), SQLC, Prisma (schema emission only), Stripe integration, and a pragmatic Makefile/CI-friendly workflow. It generates most of the boilerplate so you can focus on app logic.

## Features

- __gRPC + HTTP Gateway__: `grpc-gateway` exposes gRPC services as RESTful HTTP automatically using `google.api.http` annotations.
- __Protobuf via buf__: `buf generate` based codegen with pinned dependencies (`buf.lock`).
- __Config loader__: Centralized `api/config` loads from `.env` if present, else system env.
- __Postgres + SQLC__: Write plain SQL in `sqlc/queries/`, generate typed Go code in `internal/autogenerated/sqldb`.
- __Prisma for schema emission__: Prisma datamodel -> migration SQL emitted into `sqlc/schema/` to keep DB schema and SQLC in sync.
- __Stripe service__: Service scaffolding wired in `api/bootstrap`, gRPC server in `api/services/stripe/grpc`, Stripe gateway in `api/services/stripe/gateway/stripe`.
- __Testing__: `make test` (short) and `make test-all`. Docker image compiles per-package `.test` binaries and includes a `cmd/testrunner` for CI and Fly deploy.
- __Docker & Fly.io__: Multi-stage Dockerfile and `fly.toml` wired with a release command that runs a targeted integration test.

## Repository Layout

- `main.go`: boots both gRPC and HTTP gateway servers, registers `StripeService`.
- `api/bootstrap/`: dependency wiring (`Ensure()`, `Init()`, service injection).
- `api/config/`: `LoadConfig()` and constants, config validation tests.
- `api/database/`: connection init and helpers (tuned for Neon/PgBouncer compatibility).
- `api/router/`: HTTP router builder using `grpc-gateway` runtime mux.
- `proto/stripe/v1/stripe_service.proto`: service and HTTP annotations.
- `internal/autogenerated/`: generated `proto` and `sqldb` code, plus `mocks`.
- `sqlc/`: SQL schema (emitted by Prisma) and hand-written queries for sqlc.
- `prisma/`: Prisma datamodel and a SQL script to enforce `updated_at` triggers.
- `cmd/testrunner/`: parallel test runner used in Docker/Fly.
- `Makefile`: one-liners for setup, codegen, and tests.

## Requirements

- Go 1.24+
- pnpm (via corepack)
- buf, sqlc, mockgen, psql (Postgres client)

On macOS you can bootstrap everything:

```bash
make setup
```

This installs tools, Node dev deps (Prisma), and sets up a pre-commit hook that runs `make generate` and `make test`.

## Configuration

Configuration is centralized in `api/config/config.go`. It loads `.env` from the repo or ancestors if present, otherwise uses the process environment.

Required variables:

- `DATABASE_URL`
- `STRIPE_SECRET_KEY`
- `STRIPE_WEBHOOK_SECRET`

Optional variables:

- `INTEGRATION_BASE_URL` (used by some remote integration tests)
- `PORT` (HTTP, default 8080)
- `GRPC_PORT` (gRPC, default 50051)

Example `.env`:

```dotenv
DATABASE_URL=postgres://user:pass@host:5432/db?sslmode=require
STRIPE_SECRET_KEY=sk_test_xxx
STRIPE_WEBHOOK_SECRET=whsec_xxx
PORT=8080
GRPC_PORT=50051
```

## Code Generation

Run the full pipeline (Prisma -> SQL -> sqlc -> protobuf -> mocks):

```bash
make generate
```

Individual steps:

- __Emit SQL from Prisma__: `make prisma-sql` (validates schema then writes to `sqlc/schema/001_init.sql`)
- __Generate sqlc code__: `make sqlc-generate`
- __Update buf deps__: `make proto-deps`
- __Generate protobuf/gRPC__: `make proto-generate`
- __Generate gomock mocks__: `make mocks`

To push the Prisma schema to a real database (will ALTER the target DB):

```bash
make prisma-db-push
```

This also applies `prisma/sql/updated_at_triggers.sql` to enforce `updated_at` triggers for all tables.

## Running Locally

Start the servers:

```bash
go run .
```

Defaults:

- HTTP gateway: `:8080`
- gRPC server: `:50051`

`main.go` registers the gRPC service and the HTTP handlers in-process using `grpc-gateway`:

- `StripeService.CancelSubscription` -> `POST /api/cancel-subscription`
- `StripeService.VerifySubscriptionValidity` -> `POST /api/verify-subscription-validity`
- `StripeService.HandleWebhook` -> `POST /api/receive-stripe-webhook`
- `StripeService.AddSpendingUnits` -> `POST /api/spending-units`

### Example HTTP requests

Cancel subscription:

```bash
curl -sS localhost:8080/api/cancel-subscription \
  -H 'Content-Type: application/json' \
  -d '{"subscription_id":"sub_123"}'
```

Verify subscription validity:

```bash
curl -sS localhost:8080/api/verify-subscription-validity \
  -H 'Content-Type: application/json' \
  -d '{"user_external_id":"user_123"}'
```

Receive Stripe webhook (raw body proxied via `google.api.HttpBody`):

```bash
curl -sS localhost:8080/api/receive-stripe-webhook \
  -H 'Stripe-Signature: t=...,v1=...' \
  -H 'Content-Type: application/json' \
  -d '{"id":"evt_...","type":"invoice.payment_succeeded"}'
```

Add spending units (batch):

```bash
curl -sS localhost:8080/api/spending-units \
  -H 'Content-Type: application/json' \
  -d '{"items":[{"external_id":"evt-1","user_external_id":"user_123","amount":1,"created_at":1723500000000}]}'
```

## Database & SQLC

Schema is emitted to `sqlc/schema/001_init.sql` from `prisma/schema.prisma`. Core tables:

- `user_account` (unique `user_external_id`)
- `invalid_subscription` (FK to `user_account`)
- `free_credit` (unique per user)
- `spending_unit` (unique `external_id`, indexed by `user_external_id` and `created_at`)

Queries in `sqlc/queries/` generate typed methods (interface emitted) under `internal/autogenerated/sqldb`.

Notable queries:

- `GetUserAccount`, `UpsertUserAccount`
- `UpsertAndGetFreeCredit`
- `InsertInvalidSubscription`
- `CountUnitsBetween`, `InsertSpendingUnit`

The DB connector (`api/database/db.go`) sets `disable_prepared_statements=true` and `binary_parameters=yes` automatically for compatibility with PgBouncer/Neon.

## Protobuf & HTTP Annotations

Service definition: `proto/stripe/v1/stripe_service.proto` with `google.api.http` annotations and `google.api.HttpBody` for webhooks.

Regenerate after proto changes:

```bash
make proto-generate
```

## Testing

- __Unit (short)__: `make test` → `go test -short -p 1 -count=1 ./...`
- __Full (incl. integration)__: `make test-all` → `go test -p 1 -count=1 ./...`

Conventions:

- Name integration tests with suffix `Integration` (e.g., `TestSomething_Integration`).
- Environment/infra validation: see `api/config/config_env_integration_test.go`.
- The Docker image compiles per-package `.test` binaries; `cmd/testrunner` runs them in parallel and can target a specific integration test (used by Fly release command).

Example testrunner usage (as in `fly.toml` release command):

```bash
/app/bin/testrunner -short -pkg-parallel 8 \
  -integration-run ^TestLoadConfig_Environment_Integration$ \
  -integration-path api/config
```

## Docker

Build and run:

```bash
docker build -t stripe-starter .
docker run --rm -p 8080:8080 -p 50051:50051 \
  -e DATABASE_URL=... \
  -e STRIPE_SECRET_KEY=... \
  -e STRIPE_WEBHOOK_SECRET=... \
  stripe-starter
```

The final image is distroless (non-root) and includes `/app/bin/server` and `/app/bin/testrunner`.

## Deploying on Fly.io

Ensure required secrets are set, then:

```bash
fly deploy
```

`fly.toml` exposes HTTP on 8080 and gRPC on 50051, and runs a release command that triggers a focused integration test via `testrunner` before the app starts.

## Development Notes

- Use pnpm (via corepack) for Node dev tooling. `package.json` pins `packageManager` and Prisma.
- Keep `.env` in development; never commit secrets. All code should access env via `api/config` only.
- To regenerate all autogenerated artifacts: `make generate`.
- To update buf deps: `make proto-deps`.
- Pre-commit hook (installed by `make setup`) runs generation and tests automatically.

## Troubleshooting

- pnpm missing → run: `corepack enable && corepack prepare pnpm@9 --activate`
- sqlc missing → `brew install sqlc`
- buf missing → `brew install bufbuild/buf/buf`
- mockgen missing → `GO111MODULE=on go install github.com/golang/mock/mockgen@v1.6.0`
- `psql` missing (for triggers) → `brew install libpq && brew link --force libpq`
- DB connection issues on Neon/PgBouncer → ensure DSN is correct; the app appends `disable_prepared_statements=true` automatically.

---

If you run into issues or want to extend the template (new services, endpoints, queries), update the corresponding `.proto`, Prisma datamodel, or SQLC queries, then run `make generate`.
